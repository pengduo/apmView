<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>应用系统逻辑拓扑图</title>

    <style>
        body {
            width: 1024px;
            height: 100%;
            margin: 0 auto;
        }

        #showAlarm {
            border: 1px solid #aaa;
            border-bottom: 0;
            background: #eee;
            position: absolute;
            list-style: none;
            margin: 0;
            padding: 0;
            display: none;
        }

        #showAlarm li a {
            display: block;
            padding: 7px;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
            width: 88px;
        }

        #showAlarm li a:hover {
            background: #fff;
        }

        #xttblog {
            font-size: small;
            border: 1px solid #aaa;
            border-bottom: 0;
            background: #eee;
            position: absolute;
            list-style: none;
            margin: 0;
            padding: 0;
            display: none;
        }

        #xttblog li a {
            display: block;
            padding: 7px;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
            width: 88px;
        }

        #xttblog li a:hover {
            background: #fff;
        }

        .demo {
            color: rgb(0, 0, 255);
            font-size: small;
            border: 1px;
            background-color: gray;
            height: 100px;
            position: relative;
            width: 400px;
        }

        .demo:after {
            content: '';
            position: absolute;
            border: 10px solid transparent;
            border-top-color: gray;
            top: 100%;
            left: 10px;
        }


    </style>

    <link href="css/animate.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/jtopo-0.4.8-min-extent.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/toolbar.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>

    <script id='code'>

        var strJson = '';
        var vm = {
            NAME: "NAME",
            TYPE: "TYPE",
            x: 0,
            y: 0,
            Rel: []
        };

        $(document).ready(function ()
                {

                    function findNodeByText(text)
                    {
                        //var displayNodes = scene.getDisplayedNodes();
                        var displayNodes = scene.childs;
                        var p;
                        for (p = 0; p < displayNodes.length; p++)
                        {
                            if (displayNodes[p].elementType == 'node' && displayNodes[p].text == text)
                            {
                                return displayNodes[p];

                            }
                        }
                    }


                    function createView(data)
                    {
                            //创建节点
                            for (var i = 0; i < data.length; i++)
                            {
                                var vnode = node(data[i].TYPE, data.NAME, data[i].X, data[i].Y);
                            }

                            //创建连线
                            for (var i = 0; i < data.length; i++)
                            {
                                var nodeTextFrom = data[i].NAME;
                                var sourcenode = findNodeByText(nodeTextFrom);
                                for (var j = 0; j < data.Rel.length; j++)
                                {
                                    var destinationnode = findNodeByText(data[i].Rel[j]);
                                    var link = linkNode(sourcenode, destinationnode, false);
                                }
                            }


                    }

                    /*根据配置文件名称和监视器组名称，从配置文件中获取此监视器组的各监视器列表，示范如下
                     [{
                     "name": "169.254.165.8",
                     "type": "Port-Test",
                     "x": 229.92133633136152,
                     "y": 551.7411847165355,
                     "rel": []
                     },
                     {....}
                     ]
                     */
                    function getMGInfoFromConfigFile(mgconfigfile, strMoniterGroupName)
                    {
                        var vms1 = new Array();
                        $.ajaxSettings.async = false;
                        $.getJSON(mgconfigfile, function (data)
                        {
                            for (var i = 0; i < data.monitorgroups.length; i++)
                            {
                                if (data.monitorgroups[i].name == strMoniterGroupName)
                                {
                                    vms1 = data.monitorgroups[i].details;
                                }
                            }
                        }
                        $.ajaxSettings.async = true;
                        return vms1;

                    }

                    /*根据监视器组名称，获取此监视器组的各监视器列表，示范如下
                     [{
                     "name": "169.254.165.8",
                     "type": "Port-Test",
                     "x": 229.92133633136152,
                     "y": 551.7411847165355,
                     "rel": []
                     },
                     {....}
                     ]
                     */
                    function getMGInfoFromAPM(getMGURL, strMoniterGroupName)
                    {
                        var vmsAPI = new Array();

                        $.ajaxSettings.async = false;
                        $.getJSON(getMGURL, function (data)
                        {
                            vmsAPI = data.response.result[0].Monitors;
                        }
                        $.ajaxSettings.async = true;
                        return vmsAPI;
                    }

                    /*合并两个对象，形成监视器组拓扑图完整的数据模型，在API的基础上，增加拓扑信息
                     返回：一个合并的对象
                     */

                    function MergeVMS(vmsConfieFile, vmsAPI)
                    {
                        var vmsAll = new Array();
                        var vmRecorderConfieFile = {};
                        var vmRecorderAPI = {};
                        var vmComplete = {};

                        for (var i = 0; i < vmsConfieFile.length; i++)
                        {
                            vmRecorderConfieFile = vmsConfieFile[i];
                            for (var ii = 0; ii < vmsAPI.length; ii++)
                            {
                                if (vmsConfieFile[i].name == vmsAPI[ii].NAME)
                                {
                                    vmRecorderAPI = vmsAPI[ii];
                                    jQuery.extend(vmRecorderConfieFile, vmRecorderAPI);
                                    vmsAll.push(vmRecorderConfieFile);
                                }
                            }

                        }
                        return vmsAll;
                    }


                    var strMGCconfigfile = 'mgconfig.json';
                    var strMGAPI = 'Applications Manager.json';
                    var strMoniterGroupName = 'Applications Manager'; //当前的业务组名称

                    var vms = new Array();//当前监视器组信息
                    var vmsF = getMGInfoFromConfigFile(strMGCconfigfile,strMoniterGroupName);
                    var vmsA =getMGInfoFromAPM(strMGAPI, strMoniterGroupName);
                    vms=MergeVMS(vmsF,vmsA);


                    var apiKey = "8694a3d15ae398a724d357e146ce6981";
                    var canvas = document.getElementById('canvas');
                    var stage = new JTopo.Stage(canvas);
                    //stage.eagleEye.visible = true;
                    //showJTopoToobar(stage);

                    //获取画布中鼠标的位置
                    stage.addEventListener("mouseover", function (event) {
                        var rect = canvas.getBoundingClientRect();
                        document.getElementById("x").innerText = event.clientX - rect.left * (canvas.width / rect.width) - (scene ? scene.translateX : 0);
                        document.getElementById("y").innerText = event.clientY - rect.top * (canvas.height / rect.height) - (scene ? scene.translateY : 0);
                    });

                    //传入事件名称及当前的NODE
                    function handler(event, currentNode) {
                        if (event.button == 2) {// 右键
                            // 当前位置弹出菜单（div）
                            //alert(event.srcElement.tagName );
                            //currentNode.text = currentNode.text + ",X:" + event.pageX + ",Y:" + event.pageY;

                            $("#xttblog").css({
                                top: event.pageY,
                                left: event.pageX
                            }).show();
                        }
                    }


                    var scene = new JTopo.Scene();
                    scene.background = './img/bg.jpg';
                    stage.add(scene);


                    createView(vms);

                    //配置节点信息，增加事件
                    function node(type, name, x, y) {
                        var node = new JTopo.Node(name);
                        //node.href = 'http://www.jtopo.com';
                        //node.target = '_blank'; // 新窗口打开链接39.
                        //node.font = 'italic bold 16px 微软雅黑';40.
                        //node.visitedColor = '0,0,255'; // 访问过的链接为蓝色
                        node.setImage('./img/apm/icon_monitors_' + type + '.png', false);
                        node.setLocation(x, y);
                        node.setSize(20, 20);
                        node.fontColor = "0,22,0";
                        node.shadow = true;  //增加阴影效果
                        scene.add(node);

                        //增加监听鼠标双击事件，弹出菜单
                        node.addEventListener('dbclick', function (event) {
                            //currentNode = this;
                            //handler(event, currentNode);
                            $("#xttblog").css({
                                top: event.pageY,
                                left: event.pageX
                            }).show();

                        });

                        //增加监听事件--'移到上面了'
                        node.addEventListener('mouseover', function (event) {
                            var rect = canvas.getBoundingClientRect();
                            document.getElementById("x").innerText = event.pageX;
                            document.getElementById("y").innerText = event.pageY;

                            document.getElementById("showAlarmText").innerHTML = this.text + ':' + '的健康状况为正常. <br>根本原因 <br>1. bd_Windows 8为启用<br>2. 数据收集成功<br>';

                            $("#showAlarm").css({
                                top: event.pageY - 130,
                                left: event.pageX - 30
                            }).show();

                        });


                        //增加监听事件--'移走了'
                        node.addEventListener('mouseout', function (event) {
                            $("#showAlarm").hide();
                        });


                        return node;
                    }

                    function linkNode(nodeA, nodeZ, f) {
                        var link;
                        if (f) {
                            link = new JTopo.FoldLink(nodeA, nodeZ);
                        } else {
                            link = new JTopo.Link(nodeA, nodeZ);
                        }
                        //link.direction = 'vertical';
                        link.lineWidth = 1;
                        link.direction = 'horizontal';
                        link.arrowsRadius = 10;
                        scene.add(link);
                        return link;
                    }

                    function hostLink(nodeA, nodeZ) {
                        var link = new JTopo.FlexionalLink(nodeA, nodeZ);
                        link.shadow = false;
                        link.offsetGap = 30;
                        scene.add(link);
                        return link;
                    }

                    // 简单连线
                    function newLink(nodeA, nodeZ, text, dashedPattern) {
                        var link = new JTopo.Link(nodeA, nodeZ, text);
                        link.lineWidth = 3; // 线宽
                        link.dashedPattern = dashedPattern; // 虚线
                        link.bundleOffset = 60; // 折线拐角处的长度
                        link.bundleGap = 20; // 线条之间的间隔
                        link.textOffsetY = 3; // 文本偏移量（向下3个像素）
                        link.strokeColor = '0,200,255';
                        scene.add(link);
                        return link;
                    }

                    // 折线
                    function newFoldLink(nodeA, nodeZ, text, direction, dashedPattern) {
                        var link = new JTopo.FoldLink(nodeA, nodeZ, text);
                        link.direction = direction || 'horizontal';
                        link.arrowsRadius = 15; //箭头大小
                        link.lineWidth = 3; // 线宽
                        link.bundleOffset = 60; // 折线拐角处的长度
                        link.bundleGap = 20; // 线条之间的间隔
                        link.textOffsetY = 3; // 文本偏移量（向下3个像素）
                        //link.strokeColor = JTopo.util.randomColor(); // 线条颜色随机
                        link.dashedPattern = dashedPattern;
                        scene.add(link);
                        return link;
                    }

                    // 二次折线
                    function newFlexionalLink(nodeA, nodeZ, text, direction, dashedPattern) {
                        var link = new JTopo.FlexionalLink(nodeA, nodeZ, text);
                        link.direction = direction || 'horizontal';
                        link.arrowsRadius = 10;
                        link.lineWidth = 3; // 线宽
                        link.offsetGap = 50;
                        link.bundleGap = 15; // 线条之间的间隔
                        link.textOffsetY = 10; // 文本偏移量（向下15个像素）
                        link.strokeColor = '152,251,152';
                        link.dashedPattern = dashedPattern;
                        scene.add(link);
                        return link;
                    }

                    // 曲线
                    function newCurveLink(nodeA, nodeZ, text) {
                        var link = new JTopo.CurveLink(nodeA, nodeZ, text);
                        link.lineWidth = 3; // 线宽
                        scene.add(link);
                        return link;
                    }

                    /*
                     node.alarm = "宕机";
                     node.alarmColor = '255,0,0';  //红色
                     node.alarm = "正常";
                     node.alarmColor = '152,251,152';  //绿色
                     node.alarm = "故障";
                     node.alarmColor = '255,69,0';
                     node.alarm = "未知";
                     node.alarmColor = '119,136,153';
                     */


                    setInterval(function () {
                        if (h3.alarm == '二级告警') {
                            h3.alarm = null;
                        } else {
                            h3.alarm = '二级告警'
                        }
                    }, 600);



                    $("#showAlarm").hide();
                    $("#xttblog").hide();


                    stage.click(function (event) {
                        if (event.button == 0) {// 右键
                            // 关闭弹出菜单（div）
                            $("#showAlarm").hide();
                            $("#xttblog").hide();

                        }
                    });


                    $("#xttblog a").click(function () {
                        var text = $(this).text();

                        if (text == '故障详情') {
                            //scene.remove(currentNode);
                            //document.getElementById('txt').textContent = '可以查看故障详情';
                            document.getElementById('txt').addClass('animated bounce');
                        }

                        if (text == '主要指标') {
                            //document.getElementById('txt').textContent = '可以查看主要指标的显示情况';
                            window.location.href = "http://www.163.com";
                        }

                        if (text == '打开查看') {

                            //document.getElementById('txt').textContent = '打开详细页面';
                            window.location.href = "http://www.163.com";
                        }

                        $("#xttblog").hide();
                    });


                    //var jsonStr = stage.toJson();


                    //先将JSON对象转成字符串，然后将其中的“\”符号全部替换成空格
                    strJson = "json";
                    strJson = JSON.stringify(stage.toJson()).replace(/\\/g, "");
                    //alert(strJson);
                    document.getElementById("jsonstr1").innerHTML = strJson;


                    document.getElementById("myBtn").onclick = function () {
                        document.getElementById("jsonstr1").innerHTML = strJson;
                    };

                    console.log(jsonStr);
                    //document.getElementById('txt').textContent = jsonStr;
                    //alert(jsonStr);


                }
        )
        ;


        /*  CSS 动画类型，注意前面加”animated “，如class="animated flash"
         shake、flash、swing、bounce、tada、wobble、pulse、 flip、flipInX、flipOutX、flipInY、flipOutY
         fadeIn、fadeInUp、fadeInDown、fadeInLeft、fadeInRight、fadeInUpBig、fadeInDownBig、fadeInLeftBig、fadeInRightBig
         fadeOut、fadeOutUp、fadeOutDown、fadeOutLeft、fadeOutRight、fadeOutUpBig、fadeOutDownBig、fadeOutLeftBig、fadeOutRightBig
         slideInDown、slideInLeft、slideInRight、slideOutUp、slideOutLeft、slideOutRight、 bounceIn、bounceInDown、bounceInUp、bounceInLeft、bounceInRight
         bounceOut、bounceOutDown、bounceOutUp、bounceOutLeft、bounceOutRight、rotateIn、rotateInDownLeft、rotateInDownRight、rotateInUpLeft、rotateInUpRight
         rotateOut、rotateOutDownLeft、rotateOutDownRight、rotateOutUpLeft、rotateOutUpRight、 lightSpeedIn、lightSpeedOut、hinge、rollIn、rollOut
         */
    </script>
</head>
<body>
<ul id="xttblog" style="#xttblog">
    <li><a>故障详情</a></li>
    <li><a>主要指标</a></li>
    <li><a>打开查看</a></li>
</ul>
<div id="showAlarm" class="demo">
    <label id="showAlarmText">showalarmtext</label>
</div>

<center>

    <div id="content">
        <canvas width="1024" height="768" id="canvas"></canvas>
    </div>

    <BR>
    <label id="x">X</label>
    <label id="y">Y</label>
    <BR>
    <BR>
    <BR>

    <button id="myBtn">保存配置</button>
    <p id="jsonstr1" style="font-size: small"></p>

</center>
</body>
</html>